자, 다음분은요. 홍석주 님이시고요. 계단으로 올라와주셨네요. 

가장 편하게 올라오셨습니다.

발표 제목은 쿠버네티스에 개들을 풀어라! 입니다. 박수 부탁드립니다.

(박수)

옆에서 자료를 찾고 있는데요. 

잠시 시간을 벌어보려고 하는데 홍석주 님, 많이 긴장되시나요?

아, 괜찮다고 하십니다.

시간 보시면서 하실 거죠? 어떻게 한번 도전해보시겠어요, 5분?

아, 도전해보시겠다고 합니다. 5분을 시간을 보지 않고 하시는 홍석주 님께 다시 한 번 박수 부탁드립니다.

(박수)

-네, 안녕하세요? 쿠버네티스에 개들을 풀어라 라는 주제로 라이트닝토크 발표하게 된 홍석주라고 합니다.

저는 엔지니어로 일을 하고 있고 최근에 쿠버네티스로 서버이전 작업을 하고 있어요.

여기서 개들을 풀어라의 개는 데이터도그라는 클라우드서비스를 말을 해요. 

이 서비스는 모니터링 전문 서비스인데 알아서 필요한 지표들을 수집을 해줘요. 

CPU 사용량 이런 것도 수집을 해주고.

그리고 이런 지표에서 뭔가 이상이 있으면 멍멍이가 알려줘서 제가 새벽4시에 깨서 작업한 일도 있습니다.

그리고 쿠버네티스, 요새 핫하죠.

간략하게 설명드리자면 컨테이너를 클러스터에 쉽고 빠르게 띄워주고 죽으면 알아서 복구도 잘해주고 알아서 스케일링도 되게 잘해줘요.

그래서 저희가 서비스를 AWS에서 쿠버네티스로 이전을 하면서 데이터도그를 마찬가지로 쿠버네티스를 모니터링을 하려고 해요.

얘는 노드별로 똑같은 컨테이너가 뜨는 데몬셋이라고 해요.

그러면 매트릭들을 알아서 수집할 수 있게 해줘요.

그런데 우리는 이것만 중요한 게 아니라 그 마이크로서비스들이 엄청 많이 있는데 

예를 들어서 여러 외부 인증 관련 장애라든가 이런 지표들을 수집을 해야 하기 때문에 커스텀 매트릭을 수집해야 해요. 

그런데 저희가 데이터독으로 직접 쏠 수 없는 문제가 발생을 했어요. 같은 노드에 있는 IP를 알 수가 없었기 때문에.

그래서 저희가 호스트포트라는 기능을 이용해서 마이크로서비스가 알려주는 식으로 그렇게 수집을 하는 방식을 써

요. 이게 문서에도 적혀 있고요.

그런데 만약 이 데이터도그가 죽어요. 

그러면 새로운 데이터도그가 뜰 텐데 매트릭이 죽은 데이터도그로 자꾸 가는 거예요.

그래서 저희가 죽은 데이터도그에 가는 연결을 끊고 새걸로 이어줘야 하는 문제가 생겼어요.

그래서 이거를 어떻게 했느냐. 

이게 한 2주에서 3주 정도 고생을 해서 고안한 방법인데 새 멍멍이가 뜨기 전에 죽은 연결을 날리는 커맨드를 쓰고 그다음에 다시 지표를 수집하겠죠.

그런데 보통 컨테이너가 새로 뜨기 전에 미리 띄워서 먼저 하는 작업을 init 컨테이너라고 하는데 얘가 망했다 해서 

새로운 디플로이먼트를 만들어서 연결 좀 죽여달라고 요청을 하고 그러면 그게 죽은 연결을 날려버리는 식으로 구현을 했어요.

되게 태스크 자체는 간단한데, 그래서 살펴보면 그냥 http 콜을 잘 받고 서브프로세스 잘 실행시키고 그리고 심플해야겠죠.

그래서 제가 하나 만들었는데요. 파이콘의 기본 HTTP 모듈을 사용해서 별도의 모듈 같은 거 관리할 필요 없이 

그냥 핸들러 하나만 짜버리면 되는 문제로 바꿔서 풀었고 데이터도그가 잠깐 죽었다 다시 떠도 행복하게 모니터링이 가능해졌습니다.

그래서 이렇게 코드를 짜놨는데 단 8줄만에 행복한 모니터링이 가능해졌어요!

결론입니다. 이거 리서치하느라, 구현 관련해서는 일주일, 그리고 그 문제 찾는 거는 3주 정도 걸렸고.

그래서 결론적으로 UDP라는 호스트포트 기능을 이용할 때 CNI 플러그인 버그가 있고요.

그리고 파이썬도 http 서버는 물론 이고 이런 조그만 문제들이 쿠버네티스의 문제에서는 정말 힘든데 파이썬에서는 쉬워요.

그래서 이게 결론입니다. 감사합니다. (박수)

-(사회자) 네, 제가 핸드폰을 못 가지고 오게 잠시 막아보았는데 4분 20초만에 마무리를 잘 해주셨고요.

 다시 한 번 큰 발표... 아니, 큰 박수 부탁드리겠습니다.

