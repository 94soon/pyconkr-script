https://www.youtube.com/watch?v=5ksPJYEBYTU

안녕하세요? 이번시간에 python으로 나만의 IOT 구축하기 미세먼지 온습도 편을 준비하게 된 박상우입니다.

들어가기 앞서 이번 프로젝트 결과물 먼저 보고 들어가도록 하겠습니다.

지금 현재 보이시는 건 텔레그램으로 직접 만든 공기청정기를 제어하는 모습인데요.

어디연결할지 선택한 다음.

켜고 있으니 추워서 빨리 꺼주고.

이것은 온습도 값을 받아오는 상태입니다.

본 발표에 들어가도록 하겠습니다.

목차는 pyboard란 무엇인가.

미세먼지, 온습도, 라즈베리파이로 서버만들기, 텔레그램. 순서로 되어있습니다.

pyboard란 매우 작은 크기를 가지고 있습니다.

또 REPL이라는 모드로 스크립트 실행이 가능한데요.

왜 마이크로 SD가 필요하냐 성능을 보도록 하겠습니다.

성능은 168 MHZ 씨피유.

94KB의 python 스크립트 저장공간이 있습니다.

보시면 아마 python에서 MHZ 키로바이트 보시기 힘드실 것입니다.

그래서 마이크로 SD카드를 의무적으로 달아서 많은 용량의 프로그램을 넣을 수 있습니다.

여러 종류가 있는데요.

어떤 걸 사야 할까요?
공식 마이크로 썬 pyboard는 중국에서 따라만든 카피보드는 17달러 약 22000원 정도 역시 중국이 싸게 잘 만듭니다.

왜 카피보드이냐
성능이 똑같습니다.

그리고 쌉니다.

성능이 똑같으면 당연히싼 걸 사야죠.

계속 입이 마르고 있는데요.

이 안에 미세먼지 수치가 높은 것 같습니다.

폭염인데도 미세먼지는 좋아지지 않습니다.

연일 최고치를 찍고 그런데 일기예보에서는 매번 좋다고 합니다.

보시다시피 공원이나 건물 위에 있어서 실제 저희가 마시는 것과 다르죠.

미세먼지 센서를 사용해보겠습니다.

PMS 5003이라는 걸 사용해보도록습니다.

미세먼지가 10마이크로미터 초 미세먼지가 2.5 마이크로 미터인데.

패시브 모드를 지원해서 액티브 모드의 단점인 버퍼에 지속적으로 쌓이는 단점을 해소할 수 있습니다.

실제 측정을 해봤습니다.

PM10단위를 측정했고요.

다. 부산 모 공한에서는 52나왔고요.

서울 모 대학에서는 31.

서울 모 카페에서는 50, 공기청정기가 돌아가는 거실에서는 9, 납땜 직후 방에서 95가 나왔습니다.

오늘 들어올 때 의외로 12가 나왔습니다.

값을 받아오려면 어떻게 해야 할까요?
버퍼를 초기화해주고.

데이터 패시브 모드이니까 데이터를 받아온 다음에 버퍼에 뭔가 있으면 그 값을 출력하는 것으로 되어있습니다.

미세먼지 수치를 알았으니 공기청정기를 사용해봐야겠죠.

어떤 공기청정기냐.

자작으로 만든 공기청정기입니다.

12V팬으로 작동하고.

속도는 PWM이라는 것으로 속도를 제어합니다.

실제 테스트했 영상인데요.

1단계로 켜서 2단계에서 조금 더 세지고 3단계는 확실히 소리가 달라졌습니다.

TR회로는 이렇게 생겼습니다.

그냥 이거는 따라만들면 됩니다.

PWM으로 속도제어한다고 했는데요.

펄스 폭 제어의 약자로 예시로 12V를 1초단위로 온 오프 한다면.

이거를을 0.001초마다 반복한다면 온오프해서 켜졌다 꺼졌다 반복되면 약 6V에서 멈춰있습니다.

어떻게 사용하느냐.

타이머라는 모듈을 사용하고요.

타이머 어떤 채널할 것인지 주파수를 설정해 주고.

펄스폼은 상관없습니다.

저희는 퍼센트를 할 것이니까요.

약 8.4V단계.

다. 약 10V를 2단계.

100%일 때 에는 12V로 팬이 작동하게 됩니다.

당연히끌 때 에는 0므로 해 줍니다.

온습도가 마음에 들지 않습니다.

저기 추워보이시는 분들도 있고.

다. 그냥 반팔 별로 안 추우신가 봐요.

건조한 것 같습니다.

그래서 측정해보도록 하겠습니다.

DHT22라는 작은 센서를 사용하게 됩니다.

플러스 마이너스 0.5도, 플러스 마이너스 2%의 정밀도를 가지고 있습니다.

자세히 보면 에러가 나있죠.

제가 구매할 당시에 쓸 수 없었습니다.

자작의 본능을 따라 함수를 만들게 됩니다.

펄스출력을 공부해야 되는데요.

센서에는 데이터 시트라는 게 있습니다.

데이터 시트 안에 어떻게 쓸 수 있는지 나와있고요.

이를 따라서 만들어보도록 하겠습니다.

약 2일간의 삽질을 하고 그냥 펌웨어를 썼습니다.

윈도우 기준으로 해서 펌웨어는 핸드메이드 버전 1.9.4.

그냥 펌웨어 있으면 올리세요.

내장함수를 사용해보겠습니다.

핀을 할당해 준 후 측정해줍니다.

간혹 측정안 하고 먼저 값을 가져오면 이상한 데이터를 가져옵니다.

여기에서 온도 24도, 습도는 77% 정도.

습도는 77%는 아닌 것 같은데 오류가 있는 것 같습니다.

제방을 측정해봤습니다.

30도정도일 때 살짝 춥습니다.

31도일 때 선풍기를 틀면 됩니다.

32도이면 샤워 후 선풍기가 있으면 됩니다.

그리고 34도를 찍는 걸 봤는데요.

이건 할말이 없습니다.

습도의 경우 50% 정도 제가 안구건조등이 있어서 약을 넣어주고, 60, 70%도 있을 만 합니다.

80%는 찝찝하고.

90%는 그렇죠.

온습도를 조절해보도록 하겠습니다.

선풍기, 제방에 에어컨이 없으니까 .

B모사냐 python 라이브러리가 있습니다.

있는 건 써야 합니다.

전원을 키면 파란색 불이 들어와서 선풍기가 작동하는 걸 볼 수 있고요.

전원을 끄면 불이 지고 선풍기가 꺼지됩니다.

라즈베리파이에 제어합니다.

모듈을 불러와주고 와이파이에 연결한 다음 스마트 찾습니다.

찾은 다음에는 정보를 가져오고 전원을 켜고 끄는 걸 해주면 됩니다.

아까 온도가 24도밖에 안 됩니다.

겨울을 대비해야 합니다.

이제 가습기가 필요한 시기가 오고 있습니다.

마찬가지로 직접 만들었고요.

150W의 카트리지 히터를 사용합니다.

이를 제어하기 위해서 SSR와 pyboard의 를 사용하였습니다.

가열식 가습기가 있는 분들은 아실 텐데 그 안에 쇠판같은 게 있습니다.

안에 전선와이어라는 높은 저항을 가진 와이어가 내장되어있고요.

이 와이어의 발열을 이용한 히터인데요.

이게 70, 80년대까지는 이걸 사용해서 물을 끓였습니다.

SSR이 무엇이냐.

반도체 릴레이의 약자인데요.

리렐이는 일종의 전자 스위치입니다.

그 중 SSR이라고 불리는 건 작은 제어신호로 높은 전압제어가능하고 빠른 반응속도, 수명이 길고 노이즈가 적습니다.

그러면 당연히비싸죠.

SSR 밑에 보이는 까만 장비 이렇게 생겼습니다.

저 안에 들어있는 게 카트리지 히터이고요.

전원이 켜지면 물끓는 소리가 나죠?.

글로건이 다 녹았어요.

전원을 끄면 물이 끓지 않죠.

SSR 회로뵈신념알 수 있습니다.

220V를 물과 함께 컴퓨터 앞에서 사용했습니다.

정말 위험한 행동입니다.

안전에 주의해주세요.

다. SSR 켜서 끄는 건 간단하게 할 수 있습니다.

이를 출력모드로 설정해준 다음 그냥 켜고 끄면 됩니다.

여기까지 왔으니 서버를 만들어봐야겠죠.

IOT에서 서버의 역할은 노드는 가습기, 선풍기 센서가 달려있는 모든 것들을 통칭하고요.

외부와의 통신.

제가 집밖에서 할 수 없다면 의미가 없겠죠.

다. 데이터를 저장하는 게 중요하고요.

아주 약간의 똑똑함이 필요합니다.

일정 온도 밑일 때 뭐가 켜진다든지.

그래서 저는 라즈베리파이를 쓰기로 합니다.

왜 라즈베리파이냐.

이것은 40개의 GPIO를 가지고 있습니다.

네트워크 연결이 쉽니다.

그리고 싸죠.

35달러.

크기도 작습니다.

그래서 라즈베리파이를 썼는데 어떻게 파이보드랑 통신할 것이냐.

일단 집안에 라즈베리파이랑 pyboard가 있으니까요.

집 안에서 사용할 것이고요.

이왕이면 무선이면 좋습니다.

선이 돌아다니면 깔기 힘들고 지저분하잖아요.

그래서 ESP8266 을 사용하기로 합니다.

사실 저거 말고 다른 대안이 많은데 처음에 마이크로 python을 올리려고 했습니다.

저게 돌아다니고 있어서 쓰기로 했습니다.

ESP8266을 어떻게 쓰느냐.

AT커맨드로 제어가 가능한데요.

이 작죠.

장비를 직접적으로 제어하기 위해서 만들어진 것입니다.

시리얼 통신으로 간편하게 쓸 수 있고.

펌웨어를 올려주어야 합니다.

ESP8266를 쓰면 됩니다.

끊어줘야 하는 번거로움이 있어서 그낭 UDP 통신을 쓰기로 했습니다.

pyboard에서 데이터를 어떻게 보내느냐.

함수를 이용해서 단순하게 그냥 데이터 출력하는 걸는 만들었습니다.

그런데 우리는 에이티 커맨드를 위한 걸 만들어줘야 합니다.

그래서 함수를 일일히 만들어줘야 하는 번거로움이 있습니다.

pyboard에서 데이터따라 받으려면 어떻게 해야 되느냐.

그런데 자세히 보면 이상한 게 있습니다.

타임슬립이라는 딜레이라는 함수가 있습니다.

왜 이게 굳이 들어가느냐.

다. 버퍼에 뭔가 있으면 데이터를 받아오는데 그 버퍼가 다 쌓였다고 확신할 수 있을까요?
IOT 장비들은 9600이라는 매우 낮은 속도를 갖고 있고 그 버퍼가 쌓였다고 확신할 수 없습니다.

처음에 타임슬립을 이용해서 기다려주는 것입니다.

버퍼는 계속쌓이고 있습니다.

혹시 모르니 타임아웃 기능도 넣어주고요.

디코드도 넣어서 바스트림으로 바꿔주고 반환합니다.

라즈베리파이에서 받으려면 리시버만 쓰면 됩니다.

다 만들어져있습니다.

보내는 것도 샌드투만 쓰면 됩니다.

앞서 봤던 pyboard랑 정말 차이가 있죠.

그러면 아무 데이터만 오가면 될까요?
그래서 프로토콜을 따로 만들어줬습니다.

반드시 필요한 센서 혹은 하드웨어 타입.

약자로 온도의 경우 T, 습도는 H, 미세먼지는 D, 가습기는 R, 공기청정기는 P, 스마트 플러그는 SP라는 약자를 넣어주었습니다.

라즈베리파이에 pyboard를 등록하기 위해서 유디피 통신에서 쓰는 아이피, 포트 타입 그게 들어가고요.

REG 시작해서 아이피, 포트, 타입 넣어주면
등록하는 프로토콜로 만들어준 것입니다.

라즈베리파이에서 pyboard로 데이터를 보내는 게 두 가지 종류가 있습니다.

겟타입, 내가 어떤 형태의 타입 데이터를 달라 요청을 하고요.

pyboard에서 라즈베리파이 응답할 때 에는 지금 내가 알고 있는 값은 이것이고 잘 받았다 오케이 해서 값을 만들어줬습니다.

아까 여러 가지 설정해야 하는 게 있죠.

셋으로 시작해서 타입, 어떤 상태로 시작할 것인지, 벨류는 1, 2, 3단 끄기가 있으니까요.

이에 대해서 응답은 내가 받았고 잘 실행했다 라는 게 있습니다.

이 값들은 DB에 저장해줘야 하는데요.

앞서 봤던 pyboard의 목록관리.

어떤 게 나한테 등록되어있는지 먼저 저장해주고 현재센서값, 이 센서값이 시간별로 어떻게 되는지 알 수 있도록 센서값도 저장해주었습니다.

등록된 pyboard는 목록을 보면 아이피, 포트, 그리고 어떤 걸 할 수 있는지 나와있고요.

저장된 센서값은 아이피, 타입, 값하고 시간 순서로 나와있습니다.

이 센서값을 계속 저장하기 위해서 크론탭을 이용해서 매 분마다저장하도록 했고요.

실제 제가 저장했던 데이터입니다.

오후 8시부터 오후 12시까지 저장을 했는고요.

온도가 7시 안되는 시간에 최고점을 찍었고요.

습도의 경우 이와 같이 변했습니다.

실제는 2%도 안 변했다
88%에서 90%인데 이때부터 부산에 계속 비가 왔었거든요.

그래서 습도가 높은 수치를 찍고 있습니다.

텔레그램봇을 추가하도록 하겠습니다.

텔레그램봇은 사용자 통신하기 위해 것으로 요즘에는 어플을 이용해서 많이 하지만 저주는 텔레그램봇을 써오다 보니까 편하더라고요.

python 텔레그램봇 라이브러리라는 게 있어서 쉽게 할 수 있습니다.

커맨드 명령어를 사용하겠습니다.

제가 2016년에 써보고 안 들어가서 본프로젝트하면서 들어가봤는데 인라인 키보드라는 게 있어서 사용해보도록 하겠습니다.

먼저 실시간 값을 불러오기 위해서 겟 명령어 불러오면.

원하는 값을 선택하고요.

H, T D 원하는 값을 선택하면 값을 가져옵니다.

등록된 오드가 하나밖에 없으면 바로 가져오고요.

실제로 값을 가져오는 영상입니다.

영상에서는 보드가 등록된 게 여러 개라서 보드를 선택하고 나서 어디로 연결할지 선택을 해주고요.

선택하고 나면 알아서 값을 가져옵니다.

값이 28도 정도 이게 비가 다 오고 나서 가을이 오고 있는 것 같습니다.

하드웨어를 제어하기 위해 셋 명령어를 사용했고요.

이렇게 인라인 키보드가 뜨게 됩니다.

원하는 값을 선택하면 연결 어디로 할지 물어보고 연결할 곳을 선택하면 상태를 선택해줍니다.

릴레이는 온, 오프.

1를 선택하면 설정을 어떻게 했다.

잘 되면 완료되었습니다.

라고 나옵니다.

이거는 공기청정기를 제어하는 건데요.

뒤에는 온 오프밖에 없었지만 공기청정기는 3단으로 되어져 있으니까.

터치가 또 안 되었네요.

연결하고 나서 온 1, 2, 3이 있지요.

온 눌러주면 청정기가 작동을 하고.

다시 연결하고.

끄면 됩니다.

이런 식으로 온습도까지 해서 간단히 만들어봤는데요.

어떤 걸 더 넣을 수 있을까
라돈이나, 라돈센서를 봤는데 많이 비싸거든요.

고민 중입니다.

혹은 CO2, 혹은 물고기 키우시는 분들은 용존산소량, 토양수분 같은 걸 측정할 수 있습니다.

제어의 경우 내년 여름에는 반드시 에어컨을 제어할 것이고요.

이제 겨울이니 전기장판, 보일러.

침대에 누우면 조명, 매번 기억 안 나는 가스와 창문.

밖에 나가면 생각납니다.

이상 큐엔에이를 진행하도록 하겠습니다.
